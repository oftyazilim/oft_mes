import{d as Ie,r as n,aQ as Ye,q as ye,D as R,i as qe,g as b,o as c,f as i,b as t,aF as o,e as s,c as C,F as S,ay as U,p as x,m as N,T as V,aY as De,s as m,eB as Me}from"./main-CC0S-MzY.js";import{V as E,a as O,d as Fe}from"./VCard-XhBRIBq8.js";import{V as Ge,a as se}from"./VTabs-BARcx9S6.js";import{V as Oe,a as ne}from"./VWindowItem-BCiHlVrC.js";import{V as A}from"./VCardText-C_q08Dmo.js";import{V as P}from"./VTextField-BnwXvZKs.js";import{V as j,a as z,b as ke,d as _e}from"./VList-C_aYqxAR.js";import{V as W}from"./VSelect-CjrUJam9.js";import{V as We}from"./VCombobox-CiJRPnj8.js";import{V as be}from"./VDivider-BBoiUOj5.js";import{V as he}from"./VAlert-D2AEz_gG.js";import{V as Qe}from"./VOverlay-DbQ1vHif.js";import{V as He}from"./VSnackbar-DcsJ7WDP.js";import{V as Je}from"./VContainer-jqPhpPgM.js";import"./createSimpleFunctional-Dz-Ql0QD.js";import"./VAvatar-BHWqmz1z.js";import"./VImg-D4hgsP19.js";import"./index-B4A6uSHN.js";import"./forwardRefs-C-GTDzx5.js";import"./easing-Bybner-F.js";import"./VSlideGroup-qSVJZc4J.js";import"./scopeId-DkPTWbgx.js";import"./lazy-DVIh6mwp.js";import"./ssrBoot-CNOVlBo_.js";/* empty css                   */import"./VCounter-CnFz9zRk.js";import"./VField-Cjbo2t6i.js";import"./form-kZDJ4E4v.js";import"./VInput-CE-nSsDz.js";import"./dialog-transition-Cr-FaDmH.js";import"./VMenu-Nfu2PsQC.js";import"./VCheckboxBtn-BozgCNkb.js";import"./VSelectionControl-Cx3tW_P7.js";import"./VChip-BJQNnCkB.js";import"./filter-BUR4TqDn.js";import"./delay-CICNbzHL.js";/* empty css              */const Xe={class:"d-flex flex-wrap gap-4"},Ze={style:{"max-inline-size":"380px","min-inline-size":"320px"}},el={class:"flex-grow-1"},ll={class:"d-flex align-center gap-3 flex-wrap"},al={key:0,class:"text-medium-emphasis"},tl={class:"d-flex gap-6 flex-wrap"},il={style:{"min-inline-size":"260px"}},sl={class:"d-flex align-center justify-space-between"},nl={class:"d-flex align-center justify-space-between w-100"},rl={style:{"min-inline-size":"260px"}},ol={class:"d-flex align-center justify-space-between w-100"},ul={class:"d-flex gap-4 flex-wrap"},dl={style:{"max-inline-size":"380px","min-inline-size":"320px"}},ml={class:"d-flex gap-2 mb-2"},cl={class:"flex-grow-1"},vl={class:"d-flex align-center gap-3 flex-wrap mb-3"},pl={class:"d-flex align-center gap-3 flex-wrap"},fl={key:0,class:"text-medium-emphasis"},yl={class:"d-flex gap-6 flex-wrap"},kl={style:{"min-inline-size":"260px"}},_l={class:"d-flex gap-4 flex-wrap"},bl={class:"flex-grow-1",style:{"max-inline-size":"560px","min-inline-size":"380px"}},Vl={class:"d-flex gap-2 mb-2 flex-wrap"},gl={class:"mt-2"},wl={class:"d-flex align-center justify-space-between w-100"},xl={style:{"min-inline-size":"360px"}},oa=Ie({__name:"yetki-yonetimi",setup(zl){const I=n("users"),h=n(!1),Q=n("Yükleniyor..."),H=n(!1),re=n(""),oe=n("success"),Ve=Ye(),ge=ye("userData"),J=n([]),X=n(""),v=n(null),ue=n([]),Y=n([]),Z=n([]),ee=n([]),we=R(()=>{const a=String(X.value??"").trim().toLowerCase();return a?J.value.filter(e=>(e.name+" "+e.email).toLowerCase().includes(a)):J.value}),L=n([]),_=n(null),g=n([]),q=n(""),le=n(""),de=[{key:"planlama_oper",label:"Planlama Operatörü",perms:["read_planlama","update_planlama","read_montaj"]},{key:"montaj_sorumlu",label:"Montaj Sorumlusu",perms:["read_montaj","update_montaj"]},{key:"depo_gorevli",label:"Depo Görevlisi",perms:["read_depo","update_depo"]},{key:"okuyucu",label:"Sadece Görüntüleme",perms:["read_genel","read_montaj","read_planlama","read_depo"]},{key:"admin",label:"Yönetici (Tüm Yetkiler)",perms:["manage_all"]}],$=n(null),K=n([]),D=n("read"),M=n("montaj"),T=n(""),ae=n(""),xe=["read","create","update","delete","manage"],ze=["genel","montaj","planlama","kalite","depo","satinalma","satis","users","roles","mekanikopr","mekaniksefi","all","kalitesefi","mekanik"],F=n(""),Ce=R(()=>{const a=String(ae.value??"").trim().toLowerCase();return a?K.value.filter(e=>e.name.toLowerCase().includes(a)):K.value}),Re=R(()=>{const a=String(le.value??"").trim().toLowerCase();return a?L.value.filter(e=>String(e.name).toLowerCase().includes(a)):L.value}),me=R(()=>{const a=String(F.value??"").trim().toLowerCase();return a?Z.value.filter(e=>e.name.toLowerCase().includes(a)):Z.value}),ce=R(()=>{const a=String(F.value??"").trim().toLowerCase();return a?ee.value.filter(e=>e.name.toLowerCase().includes(a)):ee.value}),ve=R(()=>{const a=new Set(g.value);return K.value.filter(e=>a.has(e.name))});function p(a){Q.value=a,h.value=!0}function f(){h.value=!1,Q.value=""}function r(a,e="success"){re.value=a,oe.value=e,H.value=!0}async function te(a){var e,l;try{const u=(e=ge.value)==null?void 0:e.id;if(!a||!u||Number(a)!==Number(u))return;const k=((l=(await m.get("/api/auth/debug")).data)==null?void 0:l.ability_rules)||[],d=Me(k);ye("userAbilityRules").value=k,Ve.update(d),r("Yetkileriniz güncellendi.","info")}catch{}}async function Se(){p("Kullanıcılar yükleniyor...");try{const a=await m.get("/api/users/all-basic");J.value=a.data||[]}catch{r("Kullanıcılar yüklenemedi.","error")}finally{f()}}async function B(){var a,e;p("Roller yükleniyor...");try{const l=await m.get("/api/roles");L.value=((a=l.data)==null?void 0:a.roles)||[];const u=await m.get("/api/roles/available");ue.value=((e=u.data)==null?void 0:e.roles)||[]}catch{r("Roller yüklenemedi.","error")}finally{f()}}async function ie(){p("İzinler yükleniyor...");try{const a=await m.get("/api/permissions");K.value=a.data||[]}catch{r("İzinler yüklenemedi.","error")}finally{f()}}function Ue(a){v.value=a.id,Ae(),G()}async function Ae(){var a;if(v.value){p("Kullanıcı rolleri yükleniyor...");try{const l=((a=(await m.get(`/api/users/${v.value}/roles`)).data)==null?void 0:a.roles)||[];Y.value=l}finally{f()}}}async function Pe(){if(v.value){p("Roller kaydediliyor...");try{await m.post(`/api/users/${v.value}/roles`,{roles:Y.value}),await B(),await G(),r("Kullanıcının rolleri güncellendi.","success"),await te(v.value)}catch{r("Roller kaydedilemedi.","error")}finally{f()}}}async function G(){var a,e;if(v.value){p("Kullanıcı izinleri yükleniyor...");try{const l=await m.get(`/api/users/${v.value}/permissions`);Z.value=((a=l.data)==null?void 0:a.assigned)||[],ee.value=((e=l.data)==null?void 0:e.available)||[]}finally{f()}}}async function je(a){if(v.value){p("İzin ekleniyor...");try{await m.post(`/api/users/${v.value}/permissions/${a}`),await G(),r("İzin eklendi.","success"),await te(v.value)}catch{r("İzin eklenemedi.","error")}finally{f()}}}async function Le(a){if(v.value){p("İzin kaldırılıyor...");try{await m.delete(`/api/users/${v.value}/permissions/${a}`),await G(),r("İzin kaldırıldı.","success"),await te(v.value)}catch{r("İzin kaldırılamadı.","error")}finally{f()}}}async function pe(a){var e,l;_.value=a.id,p("Rol detayları yükleniyor...");try{const y=((l=(e=(await m.get(`/api/roles/${a.id}`)).data)==null?void 0:e.role)==null?void 0:l.permissions)||[];g.value=y.map(k=>k.name)}catch{g.value=(a.permissions||[]).map(y=>y.name)}finally{f()}}async function $e(){var e,l,u,y,k;const a=q.value.trim();if(a){p("Rol oluşturuluyor...");try{await m.post("/api/roles",{name:a}),q.value="",await B(),r("Rol oluşturuldu.","success")}catch(d){if(m.isAxiosError(d)&&((e=d.response)==null?void 0:e.status)===422){const w=((y=(u=(l=d.response.data)==null?void 0:l.errors)==null?void 0:u.name)==null?void 0:y[0])||((k=d.response.data)==null?void 0:k.message)||"Rol adı geçersiz veya zaten kayıtlı.";r(w,"error")}else r("Rol oluşturulurken bir hata oluştu.","error")}finally{f()}}}async function Ke(){var a,e,l,u,y,k;if(_.value){p("Rol izinleri kaydediliyor...");try{await m.put(`/api/roles/${_.value}`,{name:(a=L.value.find(w=>w.id===_.value))==null?void 0:a.name,permissions:g.value}),await B();const d=L.value.find(w=>w.id===_.value);d&&pe(d),r("Rol izinleri güncellendi.","success")}catch(d){if(m.isAxiosError(d)&&((e=d.response)==null?void 0:e.status)===422){const w=((y=(u=(l=d.response.data)==null?void 0:l.errors)==null?void 0:u.name)==null?void 0:y[0])||((k=d.response.data)==null?void 0:k.message)||"Güncelleme geçersiz: Rol adı çakışıyor.";r(w,"error")}else r("Rol güncellenirken bir hata oluştu.","error")}finally{f()}}}async function Te(){if(_.value&&confirm("Seçili rol silinsin mi? Bu işlem geri alınamaz.")){p("Rol siliniyor...");try{await m.delete(`/api/roles/${_.value}`),_.value=null,g.value=[],await B(),r("Rol silindi.","success")}finally{f()}}}async function Be(){!D.value||!M.value||(T.value=`${D.value}_${M.value}`,await fe())}async function fe(){var e,l,u,y,k;const a=T.value.trim();if(a){p("İzin oluşturuluyor...");try{await m.post("/api/permissions",{name:a}),T.value="",await ie(),r("İzin oluşturuldu.","success")}catch(d){if(m.isAxiosError(d)&&((e=d.response)==null?void 0:e.status)===422){const w=((y=(u=(l=d.response.data)==null?void 0:l.errors)==null?void 0:u.name)==null?void 0:y[0])||((k=d.response.data)==null?void 0:k.message)||"İzin adı geçersiz veya zaten kayıtlı.";r(w,"error")}else r("İzin oluşturulurken bir hata oluştu.","error")}finally{f()}}}async function Ne(a){if(confirm("Bu izin silinsin mi?")){p("İzin siliniyor...");try{await m.delete(`/api/permissions/${a}`),await ie(),r("İzin silindi.","success")}catch{r("İzin silinemedi.","error")}finally{f()}}}function Ee(){if(!$.value)return;const a=de.find(l=>l.key===$.value);if(!a)return;const e=new Set(g.value);for(const l of a.perms)e.add(l);g.value=Array.from(e),r("Şablon uygulandı.","success")}return qe(async()=>{await Promise.all([Se(),B(),ie()])}),(a,e)=>(c(),b(Je,{fluid:"",class:"pa-2"},{default:i(()=>[t(E,null,{default:i(()=>[t(O,null,{default:i(()=>e[14]||(e[14]=[o("Kullanıcı - Rol - İzin Yönetimi")])),_:1,__:[14]}),t(Fe,null,{default:i(()=>e[15]||(e[15]=[o("Sayfa ve aksiyon erişimlerini yönetin")])),_:1,__:[15]}),t(Ge,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=l=>I.value=l),class:"px-2"},{default:i(()=>[t(se,{value:"users"},{default:i(()=>e[16]||(e[16]=[o("Kullanıcılar")])),_:1,__:[16]}),t(se,{value:"roles"},{default:i(()=>e[17]||(e[17]=[o("Roller")])),_:1,__:[17]}),t(se,{value:"perms"},{default:i(()=>e[18]||(e[18]=[o("İzinler")])),_:1,__:[18]})]),_:1},8,["modelValue"]),t(Oe,{modelValue:I.value,"onUpdate:modelValue":e[12]||(e[12]=l=>I.value=l)},{default:i(()=>[t(ne,{value:"users"},{default:i(()=>[t(A,null,{default:i(()=>[s("div",Xe,[s("div",Ze,[t(P,{modelValue:X.value,"onUpdate:modelValue":e[1]||(e[1]=l=>X.value=l),label:"Kullanıcı ara",density:"compact",clearable:""},null,8,["modelValue"]),t(j,{lines:"two",rounded:"",border:"",style:{overflow:"auto","max-block-size":"60vh"}},{default:i(()=>[(c(!0),C(S,null,U(we.value,l=>(c(),b(z,{key:l.id,active:l.id===v.value,onClick:u=>Ue(l)},{default:i(()=>[t(ke,null,{default:i(()=>[o(x(l.name),1)]),_:2},1024),t(_e,null,{default:i(()=>[o(x(l.email),1)]),_:2},1024)]),_:2},1032,["active","onClick"]))),128))]),_:1})]),s("div",el,[t(E,{variant:"tonal",class:"mb-4"},{default:i(()=>[t(O,null,{default:i(()=>e[19]||(e[19]=[o("Rol Atama")])),_:1,__:[19]}),t(A,null,{default:i(()=>[s("div",ll,[t(W,{modelValue:Y.value,"onUpdate:modelValue":e[2]||(e[2]=l=>Y.value=l),items:ue.value,"item-title":"name","item-value":"name",label:"Roller",multiple:"",chips:"",clearable:"","hide-selected":"",style:{"min-inline-size":"260px"}},null,8,["modelValue","items"]),t(V,{disabled:!v.value,color:"primary",onClick:Pe},{default:i(()=>e[20]||(e[20]=[o(" Kaydet")])),_:1,__:[20]},8,["disabled"]),v.value?N("",!0):(c(),C("span",al,"Bir kullanıcı seçiniz"))])]),_:1})]),_:1}),t(E,{variant:"tonal"},{default:i(()=>[t(O,null,{default:i(()=>e[21]||(e[21]=[o("İzin Atama")])),_:1,__:[21]}),t(A,null,{default:i(()=>[s("div",tl,[s("div",il,[s("div",sl,[e[22]||(e[22]=s("div",{class:"text-subtitle-2 mb-1"},"Atanmış İzinler",-1)),t(P,{modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=l=>F.value=l),label:"Ara",density:"compact","hide-details":"auto",clearable:"",style:{"inline-size":"160px"}},null,8,["modelValue"])]),t(j,{rounded:"",border:"",style:{overflow:"auto","max-block-size":"36vh"}},{default:i(()=>[(c(!0),C(S,null,U(me.value,l=>(c(),b(z,{key:l.id},{default:i(()=>[s("div",nl,[s("span",null,x(l.name),1),t(V,{size:"small",variant:"text",color:"error",onClick:u=>Le(l.id)},{default:i(()=>e[23]||(e[23]=[o("Kaldır")])),_:2,__:[23]},1032,["onClick"])])]),_:2},1024))),128)),me.value.length===0?(c(),b(z,{key:0,title:"İzin yok"})):N("",!0)]),_:1})]),s("div",rl,[e[25]||(e[25]=s("div",{class:"text-subtitle-2 mb-1"},"Atanabilir İzinler",-1)),t(j,{rounded:"",border:"",style:{overflow:"auto","max-block-size":"36vh"}},{default:i(()=>[(c(!0),C(S,null,U(ce.value,l=>(c(),b(z,{key:l.id},{default:i(()=>[s("div",ol,[s("span",null,x(l.name),1),t(V,{size:"small",variant:"text",color:"primary",onClick:u=>je(l.id)},{default:i(()=>e[24]||(e[24]=[o("Ekle")])),_:2,__:[24]},1032,["onClick"])])]),_:2},1024))),128)),ce.value.length===0?(c(),b(z,{key:0,title:"İzin yok"})):N("",!0)]),_:1})])])]),_:1})]),_:1})])])]),_:1})]),_:1}),t(ne,{value:"roles"},{default:i(()=>[t(A,null,{default:i(()=>[s("div",ul,[s("div",dl,[s("div",ml,[t(P,{modelValue:q.value,"onUpdate:modelValue":e[4]||(e[4]=l=>q.value=l),label:"Yeni rol adı",density:"compact"},null,8,["modelValue"]),t(V,{color:"primary",onClick:$e},{default:i(()=>e[26]||(e[26]=[o("Ekle")])),_:1,__:[26]})]),t(P,{modelValue:le.value,"onUpdate:modelValue":e[5]||(e[5]=l=>le.value=l),label:"Rol ara",density:"compact",clearable:"",class:"mb-2"},null,8,["modelValue"]),t(j,{rounded:"",border:"",style:{overflow:"auto","max-block-size":"60vh"}},{default:i(()=>[(c(!0),C(S,null,U(Re.value,l=>(c(),b(z,{key:l.id,active:l.id===_.value,onClick:u=>pe(l)},{default:i(()=>[t(ke,null,{default:i(()=>[o(x(l.name),1)]),_:2},1024),t(_e,null,{default:i(()=>[o(x(l.users_count??0)+" kullanıcı",1)]),_:2},1024)]),_:2},1032,["active","onClick"]))),128))]),_:1})]),s("div",cl,[t(E,{variant:"tonal"},{default:i(()=>[t(O,null,{default:i(()=>e[27]||(e[27]=[o("Rol İzinleri")])),_:1,__:[27]}),t(A,null,{default:i(()=>[s("div",vl,[t(W,{modelValue:$.value,"onUpdate:modelValue":e[6]||(e[6]=l=>$.value=l),items:de,"item-title":"label","item-value":"key",label:"Şablon uygula",density:"compact",style:{"min-inline-size":"220px"}},null,8,["modelValue"]),t(V,{disabled:!$.value,color:"secondary",variant:"tonal",onClick:Ee},{default:i(()=>e[28]||(e[28]=[o(" Uygula")])),_:1,__:[28]},8,["disabled"])]),s("div",pl,[t(We,{modelValue:g.value,"onUpdate:modelValue":e[7]||(e[7]=l=>g.value=l),items:K.value,"item-title":"name","item-value":"name",label:"İzinler",multiple:"",chips:"",clearable:"","hide-selected":"",style:{"min-inline-size":"320px"}},null,8,["modelValue","items"]),t(V,{disabled:!_.value,color:"primary",onClick:Ke},{default:i(()=>e[29]||(e[29]=[o(" Kaydet")])),_:1,__:[29]},8,["disabled"]),t(V,{disabled:!_.value,color:"error",variant:"tonal",onClick:Te},{default:i(()=>e[30]||(e[30]=[o("Rolü Sil ")])),_:1,__:[30]},8,["disabled"]),_.value?N("",!0):(c(),C("span",fl,"Bir rol seçiniz"))]),t(be,{class:"my-4"}),s("div",yl,[s("div",kl,[e[31]||(e[31]=s("div",{class:"text-subtitle-2 mb-1"},"Bu Role Atanmış İzinler",-1)),t(j,{rounded:"",border:"",style:{overflow:"auto","max-block-size":"36vh"}},{default:i(()=>[(c(!0),C(S,null,U(ve.value,l=>(c(),b(z,{key:l.id,title:l.name},null,8,["title"]))),128)),ve.value.length===0?(c(),b(z,{key:0,title:"İzin yok"})):N("",!0)]),_:1})])])]),_:1})]),_:1})])])]),_:1})]),_:1}),t(ne,{value:"perms"},{default:i(()=>[t(A,null,{default:i(()=>[s("div",_l,[s("div",bl,[s("div",Vl,[t(W,{modelValue:D.value,"onUpdate:modelValue":e[8]||(e[8]=l=>D.value=l),items:xe,label:"Aksiyon",density:"compact",style:{"min-inline-size":"160px"}},null,8,["modelValue"]),t(W,{modelValue:M.value,"onUpdate:modelValue":e[9]||(e[9]=l=>M.value=l),items:ze,label:"Konu (Sayfa/Modül)",density:"compact",style:{"min-inline-size":"220px"}},null,8,["modelValue"]),t(V,{color:"primary",onClick:Be},{default:i(()=>e[32]||(e[32]=[o("İzin Oluştur")])),_:1,__:[32]})]),t(P,{modelValue:T.value,"onUpdate:modelValue":e[10]||(e[10]=l=>T.value=l),label:"Özel izin adı (örn: read_montaj)",density:"compact"},null,8,["modelValue"]),s("div",gl,[t(V,{color:"primary",onClick:fe},{default:i(()=>e[33]||(e[33]=[o("Ekle")])),_:1,__:[33]})]),t(be,{class:"my-4"}),t(P,{modelValue:ae.value,"onUpdate:modelValue":e[11]||(e[11]=l=>ae.value=l),label:"İzin ara",density:"compact",clearable:""},null,8,["modelValue"]),t(j,{rounded:"",border:"",style:{overflow:"auto","max-block-size":"52vh"}},{default:i(()=>[(c(!0),C(S,null,U(Ce.value,l=>(c(),b(z,{key:l.id},{default:i(()=>[s("div",wl,[s("span",null,x(l.name),1),t(V,{size:"small",color:"error",variant:"text",onClick:u=>Ne(l.id)},{default:i(()=>e[34]||(e[34]=[o("Sil")])),_:2,__:[34]},1032,["onClick"])])]),_:2},1024))),128))]),_:1})]),s("div",xl,[t(he,{type:"info",variant:"tonal",title:"İpucu",text:"İzin adları CASL ve sayfa erişimleriyle eşleşir. Örnek: read_montaj => montaj sayfalarını görüntüleme. update_planlama => Planlama sayfalarında güncelleme aksiyonları."})])])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(Qe,{persistent:"",contained:"","model-value":h.value,class:"align-center justify-center"},{default:i(()=>[t(E,{class:"pa-4 d-flex align-center justify-center"},{default:i(()=>[t(De,{indeterminate:"",color:"primary",class:"me-3"}),s("span",null,x(Q.value),1)]),_:1})]),_:1},8,["model-value"]),t(He,{modelValue:H.value,"onUpdate:modelValue":e[13]||(e[13]=l=>H.value=l),color:oe.value,timeout:"2500"},{default:i(()=>[o(x(re.value),1)]),_:1},8,["modelValue","color"])]),_:1})]),_:1}))}});export{oa as default};
