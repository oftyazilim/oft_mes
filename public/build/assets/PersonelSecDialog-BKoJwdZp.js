import{d as J,e_ as N,e$ as Q,r as k,D as W,i as X,w as Z,g as B,f as r,s as g,b as t,c as E,m as ee,e as f,aY as ie,p as x,aF as p,T as D,y as ae,l as _,ay as te,F as le,o as V,x as se}from"./main-nZxTQnOM.js";import{d as oe}from"./dayjs.min-WZT4ZYRx.js";import{s as re,D as T,k as ne,d as de,e as ue}from"./data-grid-jHiNQW0R.js";import{V as me}from"./VDialog-IVq_5M95.js";import{a as ce,b as ke,V as fe}from"./VCard-Bfw-mgSI.js";import{V as pe}from"./VCardText-DlHLLJQ_.js";import{V as _e}from"./VRow-Clv1Usj0.js";import{V as Y}from"./VCol-ConmH5PR.js";import{V as ve,a as ye,b as ge}from"./VList-BqbMebPk.js";import{V as we}from"./VSpacer-_vUsIvXG.js";import"./_commonjsHelpers-D6-XlEtG.js";import"./index-I5_zAANm.js";import"./dom_component-cC0xeaIR.js";import"./m_row_dragging-CcDuoFcH.js";import"./m_resize_observer-BT_upcUV.js";import"./m_select_box-DfWkDUwQ.js";import"./themes-DgdlDVOg.js";import"./editor-CNN2dmZK.js";import"./overlay-BEOm21Sl.js";import"./format_helper-Dh7pbzbd.js";import"./VOverlay-Bfa2tZiW.js";import"./easing-Bybner-F.js";import"./delay-7f0aloQu.js";import"./lazy-DinArc6X.js";import"./scopeId-C2inblhE.js";import"./index-C47WkqRv.js";import"./forwardRefs-C-GTDzx5.js";import"./dialog-transition-RtIy8s7t.js";import"./createSimpleFunctional-DJJTcmA0.js";import"./VAvatar-BHvE6GUI.js";import"./VImg-DYAPscyI.js";/* empty css              */import"./ssrBoot-Bn1QesbT.js";import"./VDivider-Delmwtot.js";const Se={key:0,class:"dialog-loading-overlay d-flex flex-column align-center justify-center"},Ve={style:{"font-weight":"600"}},be={class:"text-caption text-end"},he={class:"ps-6"},xe=J({__name:"PersonelSecDialog",props:N({isemriID:{},istasyonId:{},guid:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:N(["kaydedildi","iptal"],["update:modelValue"]),setup(A,{emit:j}){const I=j,v=Q(A,"modelValue"),m=A,C=k([]),u=k([]),n=k([]),y=k(!1),b=k(!1),h=k(!1),c=W(()=>y.value||h.value);function M(i){return{register_id:Number(i.register_id),ad_soyad:String(i.ad_soyad??""),kimlik_no:String(i.kimlik_no??""),sicil_no:String(i.sicil_no??""),istasyon_id:Number(i.istasyon_id??0)}}async function P(){if(b.value)return;const{data:i}=await g.get("/api/personeller"),e=Array.isArray(i)?i:Object.values(i);C.value=e.map(M),b.value=!0}X(async()=>{try{await P()}catch(i){console.error("Personeller yüklenemedi",i)}}),Z(v,async i=>{if(i){if(h.value=!0,!b.value)try{await P()}catch(e){console.error("Personeller yüklenemedi",e)}u.value=C.value.map(e=>({...e}));try{const e=await g.get("/api/aktif-ekipler",{params:{isemriID:m.isemriID,guid:m.guid}}),a=(e==null?void 0:e.data)??[],s=Array.isArray(a)?a:Object.values(a||{});n.value=s.map(l=>({register_id:Number(l.register_id),ad_soyad:l.personel_full_name,kimlik_no:String(l.citizenship_no??l.kimlik_no??""),istasyon_id:Number(l.istasyon_id??0),sicil_no:String(l.sicil_no??"")}));const o=new Set(n.value.map(l=>String(l.kimlik_no)).filter(l=>l.length>0));u.value=u.value.filter(l=>!o.has(String(l.kimlik_no)))}catch(e){console.error("Aktif ekip yüklenemedi:",e)}finally{h.value=!1}}else n.value=[],u.value=[]});const L=i=>{if(c.value)return;const e=u.value.splice(i,1)[0];e&&(n.value.some(a=>a.kimlik_no===e.kimlik_no)||n.value.push(e))},H=i=>{if(c.value)return;const e=n.value.splice(i,1)[0];if(!e)return;u.value.some(s=>s.kimlik_no===e.kimlik_no)||u.value.push(e)},F=i=>{if(c.value||n.value.some(a=>a.kimlik_no===i))return;const e=u.value.findIndex(a=>a.kimlik_no===i);e!==-1&&L(e)},O=async()=>{var e,a;if(y.value)return;y.value=!0;const i=oe().format("YYYY-MM-DD HH:mm:ss");try{const{data:s}=await g.get("/api/aktif-ekipler",{params:{isemriID:m.isemriID,guid:m.guid}}),l=(Array.isArray(s)?s:Object.values(s||{})).filter(d=>d&&d.end_work_time===null),w=new Set(l.map(d=>String(d.citizenship_no??d.kimlik_no??""))),q=new Set(n.value.map(d=>String(d.kimlik_no))),z=n.value.filter(d=>!w.has(String(d.kimlik_no))),K=Array.from(w).filter(d=>!q.has(String(d)));if(z.length){const d=z.map(S=>({istasyon_id:m.istasyonId,worder_m_id:m.isemriID,register_id:S.register_id,sicil_no:S.sicil_no,personel_full_name:S.ad_soyad,citizenship_no:S.kimlik_no,co_id:2517,start_work_time:i,end_work_time:null,guid:m.guid}));console.log("Eklenecekler:",d),await g.post("/api/ekip-kaydet",d)}K.length&&await g.put("/api/aktif-ekipler/kapat",{kimlikler:K,guid:m.guid,end_work_time:i,worder_m_id:m.isemriID,istasyon_id:m.istasyonId}),I("kaydedildi")}catch(s){const o=(e=s==null?void 0:s.response)==null?void 0:e.status,l=(a=s==null?void 0:s.response)==null?void 0:a.data;console.error("KAYIT HATASI:",o,l||s)}finally{y.value=!1,v.value=!1}},$=()=>{v.value=!1,I("iptal")},R=i=>{},G=()=>{if(c.value)return;const i=new Set(n.value.map(o=>o.kimlik_no)),e=[];for(let o=u.value.length-1;o>=0;o--){const l=u.value[o],w=l.kimlik_no;l.istasyon_id===m.istasyonId&&!i.has(w)&&(e.push(l),u.value.splice(o,1))}const a=new Set(n.value.map(o=>o.kimlik_no)),s=e.filter(o=>!a.has(o.kimlik_no));n.value.push(...s)};function U(i){var e;c.value||F((e=i==null?void 0:i.data)==null?void 0:e.kimlik_no)}return(i,e)=>(V(),B(me,{modelValue:v.value,"onUpdate:modelValue":[e[1]||(e[1]=a=>v.value=a),R],"max-width":"800"},{default:r(()=>[t(fe,{class:"personel-dialog-card"},{default:r(()=>[c.value?(V(),E("div",Se,[t(ie,{indeterminate:"",color:"primary",size:"48",class:"mb-3"}),f("span",Ve,x(y.value?"Kayıt yapılıyor...":"Yükleniyor..."),1)])):ee("",!0),t(ce,{class:"text-h6 d-flex justify-space-between align-center"},{default:r(()=>[e[3]||(e[3]=p(" Personel Seçimi ")),f("div",be,[f("div",null,[e[2]||(e[2]=f("strong",null,"Seçilen:",-1)),p(" "+x(n.value.length)+" kişi",1)])])]),_:1,__:[3]}),f("div",he,[t(D,{variant:"outlined",onClick:e[0]||(e[0]=a=>G()),disabled:c.value},{default:r(()=>[t(ae,{start:"",icon:"tabler-users"}),e[4]||(e[4]=p(" Ekip Aktar "))]),_:1,__:[4]},8,["disabled"])]),t(pe,null,{default:r(()=>[t(_e,null,{default:r(()=>[t(Y,{cols:"6"},{default:r(()=>[t(_(re),{"data-source":u.value,height:600,"key-expr":"kimlik_no","show-borders":!0,"hover-state-enabled":!1,"repaint-changes-only":!0,"focused-row-enabled":!1,"auto-navigate-to-focused-row":!1,onRowClick:U},{default:r(()=>[t(_(T),{"data-field":"ad_soyad",caption:"Ad Soyad","sort-order":"asc"}),t(_(T),{"data-field":"sicil_no",caption:"Sicil No",width:"100",visible:!1}),t(_(ne),{visible:!0,"highlight-case-sensitive":!1}),t(_(de),{mode:"virtual","row-rendering-mode":"virtual","show-scrollbar":"always"}),t(_(ue),{mode:"none"})]),_:1},8,["data-source"])]),_:1}),t(Y,{cols:"6"},{default:r(()=>[e[5]||(e[5]=f("h5",{class:"text-subtitle-2 mt-9 mb-2"},"Ekip Listesi",-1)),t(ve,{class:"border rounded",style:{"max-block-size":"535px","overflow-y":"auto"}},{default:r(()=>[(V(!0),E(le,null,te(n.value,(a,s)=>(V(),B(ye,{key:a.kimlik_no,onClick:o=>H(s),class:"cursor-pointer"},{default:r(()=>[t(ge,null,{default:r(()=>[p(x(a.ad_soyad),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1,__:[5]})]),_:1})]),_:1}),t(ke,null,{default:r(()=>[t(we),t(D,{variant:"outlined",color:"warning",onClick:$,disabled:c.value},{default:r(()=>e[6]||(e[6]=[p("Vazgeç")])),_:1,__:[6]},8,["disabled"]),t(D,{onClick:O,variant:"outlined",color:"success",disabled:c.value},{default:r(()=>e[7]||(e[7]=[p("Kaydet")])),_:1,__:[7]},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),oi=se(xe,[["__scopeId","data-v-a1dab214"]]);export{oi as default};
